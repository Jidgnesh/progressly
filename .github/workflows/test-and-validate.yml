name: Test and Validate

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check file structure
        run: |
          echo "üîç Validating project structure..."
          
          # Check required files
          required_files=(
            "index.html"
            "js/app.js"
            "js/components.js"
            "js/constants.js"
            "js/utils.js"
            "styles.css"
            "manifest.json"
            "sw.js"
          )
          
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "‚ùå Missing required files:"
            printf '  - %s\n' "${missing_files[@]}"
            exit 1
          fi
          
          echo "‚úÖ All required files present"

      - name: Validate HTML
        run: |
          echo "üîç Validating HTML..."
          
          # Check if index.html has required elements
          if ! grep -q '<div id="root"></div>' index.html; then
            echo "‚ùå Missing root div in index.html"
            exit 1
          fi
          
          if ! grep -q 'js/app.js' index.html; then
            echo "‚ùå Missing app.js script in index.html"
            exit 1
          fi
          
          echo "‚úÖ HTML structure valid"

      - name: Check JavaScript syntax
        run: |
          echo "üîç Checking JavaScript files..."
          
          # Check if files are readable and not empty
          js_files=("js/app.js" "js/components.js" "js/constants.js" "js/utils.js")
          
          for file in "${js_files[@]}"; do
            if [ ! -s "$file" ]; then
              echo "‚ùå $file is empty or missing"
              exit 1
            fi
            
            # Basic syntax check - look for common errors
            if grep -q '<<<<<<< HEAD' "$file" || grep -q '>>>>>>>' "$file"; then
              echo "‚ùå Merge conflicts found in $file"
              exit 1
            fi
          done
          
          echo "‚úÖ JavaScript files valid"

      - name: Validate manifest.json
        run: |
          echo "üîç Validating manifest.json..."
          
          if ! command -v python3 &> /dev/null; then
            echo "‚ö†Ô∏è Python3 not available, skipping JSON validation"
          else
            python3 -m json.tool manifest.json > /dev/null
            if [ $? -ne 0 ]; then
              echo "‚ùå manifest.json is not valid JSON"
              exit 1
            fi
            echo "‚úÖ manifest.json is valid JSON"
          fi

      - name: Check for console errors
        run: |
          echo "üîç Checking for common issues..."
          
          # Check for undefined variables or common issues
          if grep -r "undefined" js/*.js 2>/dev/null | grep -v "//" | grep -v "undefined" | head -5; then
            echo "‚ö†Ô∏è Found potential undefined references (review manually)"
          fi
          
          echo "‚úÖ Basic checks completed"

      - name: Summary
        run: |
          echo "## ‚úÖ Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Checked:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ HTML structure" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ JavaScript files" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Manifest file" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Project structure" >> $GITHUB_STEP_SUMMARY
